{% extends 'base.html' %} 
{% load project_tags %}
{% block title %}{{ project.title_th }}{% endblock %}

{% block extra_css %}
<style>
  .workflow-stepper .step-item { flex: 1; }
  .workflow-stepper .step-icon { 
    transition: all 0.3s ease; 
    border-width: 2px !important;
  }
  .workflow-stepper .step-icon.shadow {
    box-shadow: 0 0 0 4px rgba(13, 110, 253, 0.2) !important;
  }
</style>
{% endblock %}
{% block content %}
<div class="container">
  <!-- Project Header -->
  <div class="card border-0 shadow-sm mb-4">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-start mb-3">
        <span
          class="badge bg-{{ project.status }}-subtle text-{{ project.status }} fs-6"
        >
          {{ project.get_status_display }}
        </span>
        <small class="text-muted">
          <i class="bi bi-calendar"></i> สร้างเมื่อ {{ project.created_at|date:"d/m/Y H:i" }}
        </small>
      </div>

      <h2 class="fw-bold mb-2">{{ project.title_th }}</h2>
      {% if project.title_en %}
      <h5 class="text-muted fst-italic mb-3">{{ project.title_en }}</h5>
      {% endif %}

      <p class="lead">{{ project.description }}</p>

      <div class="row mt-4">
        <div class="col-md-6">
          <p class="mb-2">
            <i class="bi bi-person-badge text-primary"></i>
            <strong>อาจารย์ที่ปรึกษา:</strong> {{ project.advisor.get_full_name|default:"ไม่ระบุ" }}
          </p>
          {% if project.co_advisor %}
          <p class="mb-2">
            <i class="bi bi-person text-primary"></i>
            <strong>อาจารย์ที่ปรึกษาร่วม:</strong> {{
            project.co_advisor.get_full_name }}
          </p>
          {% endif %}
        </div>
        <div class="col-md-6">
          {% if project.start_date %}
          <p class="mb-2">
            <i class="bi bi-calendar-check text-success"></i>
            <strong>วันที่เริ่ม:</strong> {{ project.start_date|date:"d/m/Y" }}
          </p>
          {% endif %} {% if project.expected_completion %}
          <p class="mb-2">
            <i class="bi bi-calendar-event text-warning"></i>
            <strong>กำหนดเสร็จ:</strong> {{
            project.expected_completion|date:"d/m/Y" }}
          </p>
          {% endif %}
        </div>
      </div>

      <hr>

      <!-- Workflow Stepper -->
      <div class="workflow-stepper mb-5 mt-4">
        <div class="d-flex justify-content-between position-relative">
          <div class="progress position-absolute top-50 start-0 translate-middle-y w-100" style="height: 2px; z-index: 0;">
            <div class="progress-bar bg-success" role="progressbar" style="width: {{ current_step|add:"-1"|mul:33 }}%;" aria-valuenow="{{ current_step }}" aria-valuemin="1" aria-valuemax="4"></div>
          </div>
          {% for step in workflow %}
          <div class="step-item text-center position-relative" style="z-index: 1; width: 80px;">
            <div class="step-icon mx-auto rounded-circle d-flex align-items-center justify-content-center mb-2 
              {% if current_step > step.id %}bg-success text-white{% elif current_step == step.id %}bg-primary text-white shadow{% else %}bg-light text-muted border{% endif %}"
              style="width: 40px; height: 40px; font-weight: bold;">
              {% if current_step > step.id %}<i class="bi bi-check-lg"></i>{% else %}{{ step.id }}{% endif %}
            </div>
            <div class="step-label small fw-bold {% if current_step == step.id %}text-primary{% elif current_step > step.id %}text-success{% else %}text-muted{% endif %}">
              {{ step.name }}
            </div>
          </div>
          {% endfor %}
        </div>
      </div>

      <div class="row g-4">
        <!-- Student Section (แบบคำขอ) -->
        <div class="col-md-6">
          <div class="card h-100 border-0 shadow-sm bg-light">
            <div class="card-body">
              <h5 class="fw-bold mb-3 text-primary"><i class="bi bi-person-fill"></i> ส่วนของนักศึกษา (แบบคำขอ)</h5>
              <p class="small text-muted mb-4">สถานะปัจจุบัน: <strong>{{ workflow|dictsort:"id"|get_item:current_step|default:"จบโครงงาน" }}</strong></p>
              
              <div class="d-grid gap-2 mb-4">
                <a href="{% url 'final_pro:request_create' project.pk %}" class="btn btn-primary">
                  <i class="bi bi-file-earmark-plus"></i> ส่งแบบคำขอ (แบบ วท.)
                </a>
              </div>

              <h6 class="small fw-bold text-muted mb-2">ดาวน์โหลดแบบฟอร์มเปล่าเพื่อกรอกส่ง:</h6>
              <div class="list-group list-group-flush small">
                <a href="{% url 'final_pro:export_project_docx' project.pk 'วท.รายงาน' %}" class="list-group-item list-group-item-action border-0 bg-transparent px-0">
                  <i class="bi bi-download text-info"></i> แบบรายงานการตรวจเนื้อหา (.docx)
                </a>
                <p class="small text-muted mt-2 fst-italic">* แบบคำขออื่นๆ (วท.1-14) อยู่ในโฟลเดอร์ "แบบคำขอ"</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Advisor Section (แบบประเมิน) -->
        <div class="col-md-6">
          <div class="card h-100 border-0 shadow-sm {% if user.is_staff %}bg-success-subtle{% else %}bg-light text-muted opacity-75{% endif %}">
            <div class="card-body">
              <h5 class="fw-bold mb-3 text-success"><i class="bi bi-shield-lock-fill"></i> ส่วนของอาจารย์ (แบบประเมิน)</h5>
              {% if user.is_staff %}
                <div class="d-grid gap-2 mb-4">
                  <a href="{% url 'final_pro:evaluation_create' project.pk %}" class="btn btn-success">
                    <i class="bi bi-clipboard-check"></i> ประเมินและอนุมัติ (แบบ วท.ป.)
                  </a>
                </div>
                
                <h6 class="small fw-bold text-muted mb-2">Auto-Generate (ประทับข้อมูลอัตโนมัติ):</h6>
                <div class="row g-2">
                  <div class="col-6">
                    <a href="{% url 'final_pro:export_project_docx' project.pk 'วท.ป.1' %}" class="btn btn-outline-success btn-sm w-100 text-start">
                       วท.ป.1 ประเมินกรอบ
                    </a>
                  </div>
                  <div class="col-6">
                    <a href="{% url 'final_pro:export_project_docx' project.pk 'วท.ป.2' %}" class="btn btn-outline-success btn-sm w-100 text-start">
                       วท.ป.2 ประเมินหัวข้อ
                    </a>
                  </div>
                  <div class="col-6">
                    <a href="{% url 'final_pro:export_project_docx' project.pk 'วท.ป.5' %}" class="btn btn-outline-success btn-sm w-100 text-start">
                       วท.ป.5 ประเมินสอบ
                    </a>
                  </div>
                </div>
              {% else %}
                <div class="text-center py-4">
                  <i class="bi bi-lock fs-1 text-muted mb-2"></i>
                  <p class="small mb-0">เฉพาะอาจารย์ที่เข้าระบบเท่านั้นที่จะสามารถส่งแบบประเมินได้</p>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>


  <!-- Tabs -->
  <ul class="nav nav-tabs mb-4" role="tablist">
    <li class="nav-item">
      <a class="nav-link active" data-bs-toggle="tab" href="#evaluations">
        <i class="bi bi-clipboard-check"></i> แบบประเมิน ({{ evaluations.count }})
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-bs-toggle="tab" href="#requests">
        <i class="bi bi-file-earmark-text"></i> แบบคำขอ ({{ requests.count }})
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-bs-toggle="tab" href="#submissions">
        <i class="bi bi-upload"></i> การส่งงาน ({{ submissions.count }})
      </a>
    </li>
  </ul>

  <!-- Tab Content -->
  <div class="tab-content">
    <!-- Evaluations Tab -->
    <div id="evaluations" class="tab-pane fade show active">
      {% if evaluations %}
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>ประเภท</th>
              <th>ผู้ประเมิน</th>
              <th>คะแนน</th>
              <th>สถานะ</th>
              <th>วันที่</th>
            </tr>
          </thead>
          <tbody>
            {% for eval in evaluations %}
            <tr>
              <td>{{ eval.get_form_type_display }}</td>
              <td>{{ eval.evaluator.get_full_name }}</td>
              <td><strong>{{ eval.score|default:"-" }}</strong></td>
              <td>
                {% if eval.is_approved %}
                <span class="badge bg-success">อนุมัติ</span>
                {% else %}
                <span class="badge bg-warning">รอดำเนินการ</span>
                {% endif %}
              </td>
              <td>{{ eval.submitted_at|date:"d/m/Y H:i" }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="text-muted text-center py-4">ยังไม่มีแบบประเมิน</p>
      {% endif %}
    </div>

    <!-- Requests Tab -->
    <div id="requests" class="tab-pane fade">
      {% if requests %}
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>ประเภท</th>
              <th>ผู้ส่ง</th>
              <th>สถานะ</th>
              <th>วันที่</th>
            </tr>
          </thead>
          <tbody>
            {% for req in requests %}
            <tr>
              <td>{{ req.get_form_type_display }}</td>
              <td>{{ req.submitted_by.get_full_name }}</td>
              <td>
                <span
                  class="badge bg-{{ req.status }}-subtle text-{{ req.status }}"
                >
                  {{ req.get_status_display }}
                </span>
                {% if user.is_staff and req.status == 'pending' %}
                <div class="mt-1 d-flex gap-1">
                  <a href="{% url 'final_pro:request_status_update' req.pk 'approved' %}" class="btn btn-sm btn-success py-0 px-2" style="font-size: 0.75rem;">อนุมัติ</a>
                  <a href="{% url 'final_pro:request_status_update' req.pk 'rejected' %}" class="btn btn-sm btn-outline-danger py-0 px-2" style="font-size: 0.75rem;">ปฏิเสธ</a>
                </div>
                {% endif %}
              </td>
              <td>{{ req.submitted_at|date:"d/m/Y H:i" }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="text-muted text-center py-4">ยังไม่มีแบบคำขอ</p>
      {% endif %}
    </div>

    <!-- Submissions Tab -->
    <div id="submissions" class="tab-pane fade">
      {% if submissions %}
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>หัวข้อ</th>
              <th>ประเภท</th>
              <th>ผู้ส่ง</th>
              <th>วันที่</th>
            </tr>
          </thead>
          <tbody>
            {% for sub in submissions %}
            <tr>
              <td>{{ sub.title }}</td>
              <td>{{ sub.submission_type }}</td>
              <td>{{ sub.submitted_by.get_full_name }}</td>
              <td>{{ sub.submitted_at|date:"d/m/Y H:i" }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="text-muted text-center py-4">ยังไม่มีการส่งงาน</p>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
